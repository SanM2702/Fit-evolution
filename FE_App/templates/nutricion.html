<!DOCTYPE html>
<html lang="es">
<head>
    {% load static %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fit Evolution - Nutrici칩n</title>
    <link rel="icon" type="image/png" href="{% static 'images/logopng.png' %}">
    <link rel="stylesheet" href="../static/css/nutricion.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap" rel="stylesheet">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=BBH+Sans+Bartle&family=Edu+NSW+ACT+Cursive:wght@400..700&family=Edu+QLD+Hand:wght@400..700&family=Montserrat:ital,wght@0,100..900;1,100..900&display=swap" rel="stylesheet">
</head>
<body>
    <div id="bg-radial"></div>
    <header class="navbar animate-on-load">
        <div class="logo">FIT EVOLUTION</div>
        <nav class="nav-links">
            <button class="btn" onclick="location.href='{% url 'MenuNutricion' %}'">Menu</button>
            <button class="btn" onclick="location.href='{% url 'dashboard' %}'">Inicio</button>
            <button class="btn" onclick="location.href='{% url 'ver_perfil' %}'">Perfil</button>
            <button class="btn" onclick="location.href='{% url 'MenuNutricion' %}'">Ejercicios</button>
        </nav>
    </header>
    <main>
        <section id="seccion1" class="personal-section animate-on-load">
            <div class="cube-title-container">
                <span class="cube-title cube-title-front">RECOMENDACI칍N NUTRICIONAL</span>
                <span class="cube-title cube-title-back">{{ user.get_full_name|upper|default:user.username|upper }}</span>
            </div>
            <div class="profile-card spotlight-card">
                <div class="spotlight-bg"></div>
                <div style="display: flex; flex-direction: row; gap: 2rem; align-items: flex-start;">
                    <div class="profile-info" style="flex: 1; position: relative;">
                    <p class="profile-name"><strong>Tu ficha Fitt </strong></p>
                    <div class="profile-row">
                        <img src="../static/icons/levantamiento-de-pesas.png" alt="icono" class="profile-icon" width="32" height="32">
                        <span><strong>Objetivo:</strong> {{ profile.get_objetivo_display }}</span>
                    </div>
                    <div class="profile-row">
                        <img src="../static/icons/pastel-de-cumpleanos.png" alt="icono" class="profile-icon" width="32" height="32">
                        <span><strong>Edad:</strong> {{ profile.edad }} a침os</span>
                    </div>
                    <div class="profile-row">
                        <img src="../static/icons/capacitacion.png" alt="icono" class="profile-icon" width="32" height="32">
                        <span><strong>Peso:</strong> {{ profile.peso }} kg</span>
                    </div>
                    <div class="profile-row">
                        <img src="../static/icons/altura.png" alt="icono" class="profile-icon" width="32" height="32">
                        <span><strong>Altura:</strong> {{ profile.altura }} cm</span>
                    </div>
                    <div class="profile-row">
                        <img src="../static/icons/flama-de-fuego.png" alt="icono" class="profile-icon" width="32" height="32">
                        <span><strong>Nivel de actividad:</strong> {{ profile.get_nivel_actividad_display }}</span>
                    </div>
                    <div class="profile-row">
                        <img src="../static/icons/calendario.png" alt="icono" class="profile-icon" width="32" height="32">
                        <span><strong>D칤as de entrenamiento:</strong> 5 d칤as/semana</span>
                    </div>
                    <div class="profile-row" style="align-items: right;">
                        <img src="../static/icons/aptitud-fisica.png" alt="icono" class="profile-icon" width="32" height="32">
                        <span><strong>Tipo de entrenamiento:</strong> Fuerza</span>
                    </div>
                    </div>
                    <div class="card">
                        <div class="card__content">
                            {% if profile.foto_perfil %}
                                <img src="{{ profile.foto_perfil.url }}" alt="Foto de perfil" class="card-img" />
                            {% else %}
                                <img src="../static/images/dantt.jpg" alt="Imagen por defecto" class="card-img" />
                            {% endif %}
                        </div>
                    </div>
                    <div class="edit-btn-absolute">
                        <button class="Btn" onclick="location.href='{% url 'editar_perfil' %}'">Editar
                            <svg class="svg" viewBox="0 0 512 512">
                                <path d="M410.3 231l11.3-11.3-33.9-33.9-62.1-62.1L291.7 89.8l-11.3 11.3-22.6 22.6L58.6 322.9c-10.4 10.4-18 23.3-22.2 37.4L1 480.7c-2.5 8.4-.2 17.5 6.1 23.7s15.3 8.5 23.7 6.1l120.3-35.4c14.1-4.2 27-11.8 37.4-22.2L387.7 253.7 410.3 231zM160 399.4l-9.1 22.7c-4 3.1-8.5 5.4-13.3 6.9L59.4 452l23-78.1c1.4-4.9 3.8-9.4 6.9-13.3l22.7-9.1v32c0 8.8 7.2 16 16 16h32zM362.7 18.7L348.3 33.2 325.7 55.8 314.3 67.1l33.9 33.9 62.1 62.1 33.9 33.9 11.3-11.3 22.6-22.6 14.5-14.5c25-25 25-65.5 0-90.5L453.3 18.7c-25-25-65.5-25-90.5 0zm-47.4 168l-144 144c-6.2 6.2-16.4 6.2-22.6 0s-6.2-16.4 0-22.6l144-144c6.2-6.2 16.4-6.2 22.6 0s6.2 16.4 0 22.6z"></path>
                            </svg>
                        </button>
                    </div>
                </div>
                </div>
            </div>
            <div style="font-size:0.9rem; margin-top:0.5rem;">
            </div>
            <div class="recommendations">
                <h3>Para alcanzar tus objetivos 游댠</h3>
                <div id="loading" class="loading-spinner">
                    <div class="spinner"></div>
                    <p>Cargando recomendaciones personalizadas...</p>
                </div>
                <div id="macros-container" style="display: none;">
                    <ul>
                        <li><strong>Calor칤as diarias:</strong> <span id="calorias">-</span> kcal</li>
                        <li><strong>Prote칤nas:</strong> <span id="proteinas">-</span> g</li>
                        <li><strong>Carbohidratos:</strong> <span id="carbohidratos">-</span> g</li>
                        <li><strong>Grasas:</strong> <span id="grasas">-</span> g</li>
                    </ul>
                </div>
            </div>

            <style>
            .loading-spinner {
                text-align: center;
                padding: 20px;
            }

            .spinner {
                width: 40px;
                height: 40px;
                margin: 0 auto 10px;
                border: 4px solid rgba(0, 0, 0, 0.1);
                border-radius: 50%;
                border-top-color: #4CAF50;
                animation: spin 1s ease-in-out infinite;
            }

            @keyframes spin {
                to { transform: rotate(360deg); }
            }
            </style>

            <script>
            document.addEventListener('DOMContentLoaded', function() {
                // Obtener recomendaciones de macronutrientes
                fetch('/api/macronutrientes/')
                    .then(response => {
                        if (!response.ok) {
                            throw new Error('Error al cargar las recomendaciones');
                        }
                        return response.json();
                    })
                    .then(data => {
                        // Actualizar la interfaz con los datos
                        document.getElementById('calorias').textContent = data.calorias || '-';
                        document.getElementById('proteinas').textContent = data.proteinas || '-';
                        document.getElementById('carbohidratos').textContent = data.carbohidratos || '-';
                        document.getElementById('grasas').textContent = data.grasas || '-';
                        
                        // Ocultar spinner y mostrar contenido
                        document.getElementById('loading').style.display = 'none';
                        document.getElementById('macros-container').style.display = 'block';
                        
                        // Construir secciones din치micas
                        buildSnacksSugeridos(data);
                        buildAlimentosSugeridos(data);
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        document.getElementById('loading').innerHTML = 
                            '<p style="color: #ff4444;">Error al cargar las recomendaciones. Recargando en 5 segundos...</p>';
                        setTimeout(() => window.location.reload(), 5000);
                    });

                // Helpers para construir tarjetas con macros
                function makeCardHTML(titulo, kcal, p, c, g) {
                    return `
                        <div class="macro-card">
                            <h4>${titulo}</h4>
                            <div class="macro-grid">
                                <div><span class="pill kcal">${kcal}</span><small>kcal</small></div>
                                <div><span class="pill p">${p}</span><small>g prote칤na</small></div>
                                <div><span class="pill c">${c}</span><small>g carbs</small></div>
                                <div><span class="pill g">${g}</span><small>g grasas</small></div>
                            </div>
                        </div>`;
                }

                function buildSnacksSugeridos(data) {
                    const cont = document.getElementById('snacks-container');
                    if (!cont || !data || !data.calorias) return;
                    // Dos snacks: 15% y 10% del total
                    const partes = [0.15, 0.10];
                    const snacksBase = ['Yogur griego con frutos rojos', 'Tostadas integrales con aguacate'];
                    cont.innerHTML = '';
                    partes.forEach((frac, idx) => {
                        const p = Math.round((data.proteinas || 0) * frac);
                        const c = Math.round((data.carbohidratos || 0) * frac);
                        const g = Math.round((data.grasas || 0) * frac);
                        const kcal = p*4 + c*4 + g*9;
                        cont.innerHTML += makeCardHTML(`${snacksBase[idx]} (Snack ${idx+1})`, kcal, p, c, g);
                    });
                }

                function buildAlimentosSugeridos(data) {
                    const cont = document.getElementById('foods-container');
                    if (!cont) return;
                    // Cuatro opciones de comida r치pida con reparto aproximado
                    const opciones = [
                        { t: 'Pollo a la plancha con arroz', ratios: {p:0.30, c:0.25, g:0.15} },
                        { t: 'Salm칩n con quinoa',             ratios: {p:0.25, c:0.20, g:0.25} },
                        { t: 'Huevos y avena',               ratios: {p:0.20, c:0.25, g:0.15} },
                        { t: 'Wok de tofu y verduras',       ratios: {p:0.20, c:0.25, g:0.15} },
                    ];
                    cont.innerHTML = '';
                    opciones.forEach(opt => {
                        const p = Math.round((data.proteinas || 0) * opt.ratios.p);
                        const c = Math.round((data.carbohidratos || 0) * opt.ratios.c);
                        const g = Math.round((data.grasas || 0) * opt.ratios.g);
                        const kcal = p*4 + c*4 + g*9;
                        cont.innerHTML += makeCardHTML(opt.t, kcal, p, c, g);
                    });
                }
            });
            </script>
        </section>
    <section id="seccion3" class="extra-section animate-on-load">
            <h2>Snacks sugeridos</h2>
            <div id="snacks-container" class="macro-cards"></div>
        </section>
    <section id="seccion4" class="extra-section animate-on-load">
            <h2>Alimentos sugeridos</h2>
            <div id="foods-container" class="macro-cards"></div>
        </section>
        </main>
        <script>
        // Fondo animado
        window.addEventListener('DOMContentLoaded', () => {
            const bg = document.getElementById('bg-radial');
            // Peque침o retraso para hacerlo m치s cinematogr치fico
            setTimeout(() => {
                bg.classList.add('visible');
            }, 1000); // peque침o retraso para el efecto
        });
        // Animaci칩n de entrada para los elementos principales
        window.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.animate-on-load').forEach((el, i) => {
                setTimeout(() => {
                    el.classList.add('animated-in');
                }, 200 + i * 200);
            });
        });
        // Animaci칩n de cubo girando en el t칤tulo
        const cubeContainer = document.querySelector('.cube-title-container');
        let cubeFlipped = false;
        setInterval(() => {
            cubeFlipped = !cubeFlipped;
            if (cubeFlipped) {
                cubeContainer.classList.add('flipped');
            } else {
                cubeContainer.classList.remove('flipped');
            }
        }, 6000);
        // JS para el men칰 desplegable tipo acorde칩n
        document.querySelectorAll('.accordion-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                this.classList.toggle('active');
                const content = this.nextElementSibling;
                if (content.style.maxHeight) {
                    content.style.maxHeight = null;
                } else {
                    content.style.maxHeight = content.scrollHeight + 'px';
                }
            });
        });
    </script>
    <style>
        .macro-cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:1rem;margin-top:1rem}
        .macro-card{background:rgba(255,255,255,0.04);border:1px solid rgba(255,255,255,0.08);padding:1rem;border-radius:12px;backdrop-filter:blur(6px)}
        .macro-card h4{margin:0 0 .5rem 0}
        .macro-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:.5rem;align-items:center}
        .pill{display:inline-block;padding:.25rem .5rem;border-radius:999px;font-weight:700}
        .pill.kcal{background:#222;color:#ffd166}
        .pill.p{background:#1b4332;color:#b7e4c7}
        .pill.c{background:#023047;color:#8ecae6}
        .pill.g{background:#3a0ca3;color:#cdb4db}
        small{display:block;opacity:.8}
    </style>
    </body>
    </html>
